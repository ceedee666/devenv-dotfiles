#!/bin/zsh

set -e

copy_data () {
  local entry=$1

  # Print the name of the selected login
  echo "Name: $(printf "%s" "$entry" | jq -r ".name")"
  echo "> Copying Username"
  # Copy the username to the clipboard
  printf "%s" "$entry" | jq -r ".login.username" | pbcopy
  echo "> Press any key to copy password..."
  # Wait for user input before coping the password
  read
  echo "> Copying Password"
  # Copy the password to the clipboard
  printf "%s" "$entry" | jq -r ".login.password" | pbcopy
}

main() {
  local searchterm=$1

  #Unlock the vault an store the session key
  local sessionkey=$(bw unlock --raw)

  # Search for passwords using the search term
  local logins="$(bw list items --search $searchterm --session=$sessionkey)"

  if [ $(printf "%s" "$logins" | jq ". | length") -eq 1 ]
  then
    login="$(printf "%s" "$logins" | jq ".[0]")"
  else
    name="$(printf "%s" "$logins" | jq -r ".[].name" | fzf --reverse)"
    login="$(printf "%s" "$logins" | jq ".[] | select(.name == \"$name\")")"
  fi

  copy_data $login
}

main "$@"
